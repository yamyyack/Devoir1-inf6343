import random
import math

#plays as the file given
class PlayerFile:
    def __init__(self, filename):
        self.file = open(filename, "r")
        self.value = ""

    def NextChoice(self):
        self.value = self.file.readline().strip()

class PlayerExploreExploit:
    def __init__(self):
        self.ChoiceCount = [0, 0, 0]
        self.ChoiceWeightedAverage = [0, 0, 0]
        self.value = ""

    # updates the value of the score received
    #finds the weighted average
    def update(self, pos, val):
        if(pos == "R"):
            SommeSuite = (self.ChoiceCount[0] * (self.ChoiceCount[0]+1))/2
            OldWeight = (self.ChoiceWeightedAverage[0] * (SommeSuite - self.ChoiceCount[0]))/SommeSuite
            NewWeight = (val * (self.ChoiceCount[0]))/SommeSuite
            self.ChoiceWeightedAverage[0] = OldWeight + NewWeight
        if (pos == "P"):
            SommeSuite = (self.ChoiceCount[1] * (self.ChoiceCount[1] + 1)) / 2
            OldWeight = (self.ChoiceWeightedAverage[1] * (SommeSuite - self.ChoiceCount[1])) / SommeSuite
            NewWeight = (val * (self.ChoiceCount[1])) / SommeSuite
            self.ChoiceWeightedAverage[1] = OldWeight + NewWeight
        if (pos == "C"):
            SommeSuite = (self.ChoiceCount[2] * (self.ChoiceCount[2] + 1)) / 2
            OldWeight = (self.ChoiceWeightedAverage[2] * (SommeSuite - self.ChoiceCount[2])) / SommeSuite
            NewWeight = (val * (self.ChoiceCount[2])) / SommeSuite
            self.ChoiceWeightedAverage[2] = OldWeight + NewWeight

    def NextChoice(self):
        totalcount = sum(self.ChoiceCount)
        upperbound = 0
        selection = -1
        for i in range(3):
            value = 0
            # if the play was never made
            if(self.ChoiceCount[i] == 0):
                value = 1e400
            # if the play was made
            else:
                #gets the weighted average for that play
                mean = self.ChoiceWeightedAverage[i]
                # how long ago was the play made
                delta = math.sqrt(2 * math.log(totalcount)/self.ChoiceCount[i])
                value = mean + delta
            if(value > upperbound):
                upperbound = value
                selection = i
        self.ChoiceCount[selection] += 1
        # translates the position to a play
        if (selection == 0):
            self.value = "R"
        if (selection == 1):
            self.value = "P"
        if (selection == 2):
            self.value = "C"

def Play():
    p1.NextChoice()
    p2.NextChoice()

    updatevalue = -1
    # calculates the value of the play (0 for loss, 1 for tie, 2 for win)
    if (p1.value == p2.value):
        print("both tie with " + p1.value)
        updatevalue = 1
    elif (p1.value == "C"):
        if (p2.value == "P"):
            print("p1 wins : p1 C; p2 P")
            updatevalue = 2
        else:
            print("p2 wins : p1 C; p2 R")
            updatevalue = 0

    elif (p1.value == "P"):
        if (p2.value == "R"):
            print("p1 wins : p1 P; p2 R")
            updatevalue = 2
        else:
            print("p2 wins : p1 P; p2 C")
            updatevalue = 0

    elif (p1.value == "R"):
        if (p2.value == "C"):
            print("p1 wins : p1 R; p2 C")
            updatevalue = 2
        else:
            print("p2 wins : p1 R; p2 P")
            updatevalue = 0

    p1.update(p1.value, updatevalue)


p1 = PlayerExploreExploit()
p2 = PlayerFile("joueur600.txt")

f = open("testExploreExploitRecency600_1.txt", "x")


p2.NextChoice()
p1.NextChoice()
print(p1.value)

#plays the game a certain amount of times equal to the number in the file
for i in range(int(p2.value)):
    Play()
    f.write(p1.value + " " + p2.value + "\n")
    print(p1.ChoiceCount)
    print(p1.ChoiceWeightedAverage)